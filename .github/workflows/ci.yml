name: Docker Image CICD
run-name: "${{ github.event.head_commit.message }} (${{ github.sha }})"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  docker-build:

    runs-on: ubuntu-latest

    steps:
    - name: Print working directory
      run: pwd

    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker compose up --detach --wait --wait-timeout 30

    - name: Show container status
      run: docker ps 

    - name: Tailscale connection
      uses: tailscale/github-action@v2
      with:
        oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
        oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
        tags: tag:cicd-pipeline

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh/
        echo "${{ secrets.SSH_PRIV_KEY }}" > ~/.ssh/id_ed25519
        echo "${{ secrets.SSH_PUB_KEY }}" > ~/.ssh/id_ed25519.pub
        chmod 600 ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519.pub
        ssh-keyscan -H ${{ secrets.TS_TARGET_SERVER }} >> ~/.ssh/known_hosts

    - name: Bring down Traefik container on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TS_TARGET_SERVER }}
        username: ${{ secrets.TARGET_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIV_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          cd ${{ github.event.repository.name }} && docker compose down

    - name: Preserve certificate data
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TS_TARGET_SERVER }}
        username: ${{ secrets.TARGET_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIV_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          mkdir -p letsencrypt
          [ -f ${{ github.event.repository.name }}/volumes/traefik/letsencrypt/acme.json ] && cp ${{ github.event.repository.name }}/volumes/traefik/letsencrypt/acme.json letsencrypt/acme.json
          [ ! -f letsencrypt/acme.json ] && echo "{}" > letsencrypt/acme.json

    - name: Delete directory on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TS_TARGET_SERVER }}
        username: ${{ secrets.TARGET_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIV_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          ssh ${{ secrets.TS_TARGET_SERVER }} 'ls ${{ github.event.repository.name }}'

    - name: Deploy files
      run: |
        rsync -avh --exclude=".[!.]*" * ${{ secrets.TS_TARGET_SERVER }}:/root/${{ github.event.repository.name }}

    - name: Restore certificate data
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TS_TARGET_SERVER }}
        username: ${{ secrets.TARGET_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIV_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          ssh ${{ secrets.TS_TARGET_SERVER }} 'cp letsencrypt/acme.json ${{ github.event.repository.name }}/volumes/traefik/letsencrypt/acme.json'

    - name: Bring up Traefik container on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.TS_TARGET_SERVER }}
        username: ${{ secrets.TARGET_SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIV_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          ssh ${{ secrets.TS_TARGET_SERVER }} 'cd ${{ github.event.repository.name }} && docker compose up -d'